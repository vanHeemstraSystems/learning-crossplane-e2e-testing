apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xstorageaccounts.storage.example.io
  labels:
    provider: azure
    type: standard
spec:
  compositeTypeRef:
    apiVersion: storage.example.io/v1alpha1
    kind: XStorageAccount
  
  mode: Pipeline
  pipeline:
  - step: patch-and-transform
    functionRef:
      name: function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
      # NOTE:
      # This example uses the namespaced Upbound Azure API groups (with `.m.`),
      # to match the XRD `scope: Namespaced`.

      - name: resourcegroup
        base:
          apiVersion: azure.m.upbound.io/v1beta1
          kind: ResourceGroup
          spec:
            forProvider:
              location: westeurope
              tags:
                managedBy: crossplane
                environment: test
        patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.parameters.location
          toFieldPath: spec.forProvider.location
        - type: FromCompositeFieldPath
          fromFieldPath: spec.parameters.resourceGroupName
          toFieldPath: metadata.name

      - name: storageaccount
        base:
          apiVersion: storage.azure.m.upbound.io/v1beta1
          kind: Account
          spec:
            forProvider:
              accountReplicationType: LRS
              accountTier: Standard
              # Ensure we create a general-purpose v2 storage account.
              # Some Azure APIs (e.g. FileServices) are not available for Blob-only account kinds.
              accountKind: StorageV2
              resourceGroupName: crossplane-e2e-test-rg
              tags:
                managedBy: crossplane
                environment: test
        patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.parameters.location
          toFieldPath: spec.forProvider.location
        - type: FromCompositeFieldPath
          fromFieldPath: spec.parameters.accountTier
          toFieldPath: spec.forProvider.accountTier
        - type: FromCompositeFieldPath
          fromFieldPath: spec.parameters.replicationType
          toFieldPath: spec.forProvider.accountReplicationType
        - type: FromCompositeFieldPath
          fromFieldPath: spec.parameters.resourceGroupName
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          # Set a stable, valid Kubernetes object name (also used as Azure name by default).
          # Azure Storage Account names must be globally unique and must be lowercase letters+numbers only.
          # Example: `test-storage-e2e-001` -> `teststoragee2e001`.
          toFieldPath: metadata.name
          transforms:
          - type: string
            string:
              type: Regexp
              regexp:
                match: '[^a-z0-9]'
                replace: ''
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          # Also set the Azure name explicitly via external-name annotation (nice for visibility).
          toFieldPath: metadata.annotations[crossplane.io/external-name]
          transforms:
          - type: string
            string:
              type: Regexp
              regexp:
                match: '[^a-z0-9]'
                replace: ''
        - type: ToCompositeFieldPath
          fromFieldPath: metadata.annotations[crossplane.io/external-name]
          toFieldPath: status.storageAccountName
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.primaryBlobEndpoint
          toFieldPath: status.primaryEndpoint
        readinessChecks:
        - type: MatchString
          fieldPath: status.atProvider.provisioningState
          matchString: Succeeded
  
  - step: auto-ready
    functionRef:
      name: function-auto-ready
